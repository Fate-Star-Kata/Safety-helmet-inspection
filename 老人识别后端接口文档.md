# Django 后端接口文档 - 管理员模块

## 1. 接口基础信息

### 1.1 技术框架

- **框架**: Django REST Framework (DRF)
- **认证方式**: JWT (JSON Web Token)
- **数据格式**: JSON
- **日期时间格式**: ISO8601 (YYYY-MM-DDTHH:MM:SS.sssZ)
- **接口前缀**: `/api/admin/`

### 1.2 通用响应格式

```json
{
  "code": 200,
  "msg": "success" | null,
  "data": {}
}
```

### 1.3 分页格式

遵循Django REST Framework分页规范：

```json
{
  "code": 200,
  "msg": null,
  "data": {
    "total": 100,
    "page": 1,
    "page_size": 20,
    "results": []
  }
}
```

### 1.4 权限级别

- **超级管理员** (`is_superuser=True`): 所有权限
- **工作人员** (`is_staff=True`): 基础管理权限
- **普通用户** (`is_active=True`): 只读权限

---

## 2. 用户管理模块 (User Management)

### 2.1 获取用户列表

**接口路径**: `GET /api/admin/users/`

**权限要求**: `is_staff=True`

**请求参数**:

```json
{
  "query": "搜索关键词",  // 可选，用户名或邮箱搜索
  "page": 1,              // 可选，页码，默认1
  "page_size": 10         // 可选，每页数量，默认10
}
```

**响应数据**:

```json
{
  "code": 200,
  "msg": null,
  "data": {
    "users": [
      {
        "id": 1,
        "username": "admin",
        "email": "admin@example.com",
        "is_active": true,
        "is_staff": true,
        "is_superuser": false,
        "date_joined": "2024-01-01T00:00:00.000Z",
        "last_login": "2024-01-15T10:30:00.000Z"
      }
    ],
    "total": 50
  }
}
```

**错误响应**:

- `401`: 未认证
- `403`: 权限不足

### 2.2 获取用户详情

**接口路径**: `GET /api/admin/users/{user_id}/`

**权限要求**: `is_staff=True`

**路径参数**:

- `user_id`: 用户ID

**响应数据**:

```json
{
  "code": 200,
  "msg": null,
  "data": {
    "id": 1,
    "username": "admin",
    "email": "admin@example.com",
    "is_active": true,
    "is_staff": true,
    "is_superuser": false,
    "date_joined": "2024-01-01T00:00:00.000Z",
    "last_login": "2024-01-15T10:30:00.000Z"
  }
}
```

### 2.3 创建用户

**接口路径**: `POST /api/admin/users/`

**权限要求**: `is_superuser=True`

**请求体**:

```json
{
  "username": "newuser",
  "email": "newuser@example.com",
  "password": "password123",
  "is_active": true,
  "is_staff": false,
  "is_superuser": false
}
```

**响应数据**:

```json
{
  "code": 201,
  "msg": "用户创建成功",
  "data": {
    "user_id": 2,
    "username": "newuser"
  }
}
```

### 2.4 更新用户

**接口路径**: `PUT /api/admin/users/{user_id}/`

**权限要求**: `is_superuser=True`

**请求体**:

```json
{
  "username": "updateduser",
  "email": "updated@example.com",
  "is_active": false,
  "is_staff": true,
  "is_superuser": false
}
```

### 2.5 删除用户

**接口路径**: `DELETE /api/admin/users/{user_id}/`

**权限要求**: `is_superuser=True`

**响应数据**:

```json
{
  "code": 200,
  "msg": "用户删除成功"
}
```

---

## 3. 仪表盘模块 (Dashboard)

### 3.1 系统概览

**接口路径**: `GET /api/admin/dashboard/overview/`

**权限要求**: `is_staff=True`

**响应数据**:

```json
{
  "code": 200,
  "msg": null,
  "data": {
    "cameras": {
      "total": 10,
      "online": 8,
      "offline": 2
    },
    "users": {
      "total": 50
    },
    "warnings": {
      "total": 120,
      "pending": 15,
      "today": 8
    },
    "detections": {
      "today": 245,
      "accuracy": 95.5
    },
    "system": {
      "availability": 99.8
    }
  }
}
```

### 3.2 统计分析

**接口路径**: `GET /api/admin/dashboard/statistics/`

**权限要求**: `is_staff=True`

**请求参数**:

```json
{
  "type": "daily",           // 可选: daily, weekly, monthly
  "days": 7,                 // 可选: 天数
  "start_date": "2024-01-01", // 可选: 开始日期
  "end_date": "2024-01-31"    // 可选: 结束日期
}
```

**响应数据**:

```json
{
  "code": 200,
  "msg": null,
  "data": {
    "detection_trend": [
      {
        "date": "2024-01-15",
        "count": 45
      }
    ],
    "warning_trend": [
      {
        "date": "2024-01-15",
        "count": 3
      }
    ],
    "warning_by_level": [
      {
        "warning_level": "critical",
        "count": 5
      }
    ],
    "camera_activity": [
      {
        "camera__name": "摄像头-001",
        "count": 120
      }
    ],
    "date_range": {
      "start": "2024-01-01",
      "end": "2024-01-31"
    }
  }
}
```

### 3.3 检测统计

**接口路径**: `GET /api/admin/dashboard/detection-stats/`

**权限要求**: `is_staff=True`

**请求参数**:

```json
{
  "camera_id": "cam_001",     // 可选: 摄像头ID
  "date_range": 7,            // 可选: 天数范围
  "start_date": "2024-01-01", // 可选: 开始日期
  "end_date": "2024-01-31"    // 可选: 结束日期
}
```

**响应数据**:

```json
{
  "code": 200,
  "msg": null,
  "data": {
    "stats": {
      "total_detections": 1250,
      "person_count": 800,
      "wearing_hat_count": 720,
      "no_hat_count": 80,
      "avg_confidence": 92.5,
      "compliance_rate": 90.0
    }
  }
}
```

### 3.4 活动日志

**接口路径**: `GET /api/admin/dashboard/activity-logs/`

**权限要求**: `is_staff=True`

**请求参数**:

```json
{
  "page": 1,
  "page_size": 20,
  "type": "warning"  // 可选: user, warning, system
}
```

**响应数据**:

```json
{
  "code": 200,
  "msg": null,
  "data": {
    "logs": [
      {
        "id": 1,
        "type": "warning",
        "action": "创建警告",
        "description": "检测到未佩戴安全帽",
        "user": "system",
        "timestamp": "2024-01-15T10:30:00.000Z",
        "severity": "warning"
      }
    ],
    "total": 500,
    "page": 1,
    "page_size": 20
  }
}
```

### 3.5 摄像头列表

**接口路径**: `GET /api/admin/dashboard/cameras/`

**权限要求**: `is_staff=True`

**请求参数**:

```json
{
  "query": "摄像头名称",      // 可选: 搜索关键词
  "page": 1,
  "page_size": 20,
  "status": "online"        // 可选: online, offline
}
```

**响应数据**:

```json
{
  "code": 200,
  "msg": null,
  "data": {
    "total": 10,
    "page": 1,
    "page_size": 20,
    "cameras": [
      {
        "camera_id": "cam_001",
        "name": "摄像头-001",
        "location": "工地入口",
        "is_online": true,
        "ip_address": "192.168.1.100",
        "port": 8080,
        "rtsp_url": "rtsp://192.168.1.100:554/stream",
        "is_active": true,
        "last_heartbeat": "2024-01-15T10:30:00.000Z",
        "created_at": "2024-01-01T00:00:00.000Z"
      }
    ]
  }
}
```

---

## 4. 警告管理模块 (Warnings)

### 4.1 获取警告列表

**接口路径**: `GET /api/admin/warnings/`

**权限要求**: `is_staff=True`

**请求参数**:

```json
{
  "page": 1,
  "page_size": 20,
  "status": "pending",        // 可选: pending, processing, resolved, ignored
  "camera_id": "cam_001",     // 可选: 摄像头ID
  "severity": "critical",     // 可选: info, warning, high, critical
  "date_from": "2024-01-01",  // 可选: 开始日期
  "date_to": "2024-01-31"     // 可选: 结束日期
}
```

**响应数据**:

```json
{
  "code": 200,
  "msg": null,
  "data": {
    "total": 150,
    "page": 1,
    "page_size": 20,
    "warnings": [
      {
        "id": "warn_001",
        "title": "未佩戴安全帽警告",
        "description": "检测到工人未佩戴安全帽",
        "warning_level": "critical",
        "status": "pending",
        "camera_id": "cam_001",
        "camera_name": "摄像头-001",
        "location": "工地入口",
        "created_at": "2024-01-15T10:30:00.000Z",
        "resolved_by": null,
        "resolved_at": null,
        "confidence": 95.5,
        "person_count": 2,
        "violation_count": 1,
        "detection_time": "2024-01-15T10:30:00.000Z",
        "image_url": "/media/detections/warn_001.jpg"
      }
    ]
  }
}
```

### 4.2 创建警告

**接口路径**: `POST /api/admin/warnings/`

**权限要求**: `is_staff=True`

**请求体**:

```json
{
  "camera_id": "cam_001",
  "warning_level": "critical",
  "title": "未佩戴安全帽警告",
  "description": "检测到工人未佩戴安全帽",
  "assigned_to": "user_001"  // 可选: 指派给用户
}
```

**响应数据**:

```json
{
  "code": 201,
  "msg": "警告创建成功",
  "data": {
    "warning_id": "warn_002",
    "created_at": "2024-01-15T10:35:00.000Z"
  }
}
```

### 4.3 更新警告状态

**接口路径**: `PUT /api/admin/warnings/{warning_id}/status/`

**权限要求**: `is_staff=True`

**请求体**:

```json
{
  "status": "resolved",
  "notes": "已通知工人佩戴安全帽"  // 可选: 处理备注
}
```

**响应数据**:

```json
{
  "code": 200,
  "msg": "警告状态更新成功"
}
```

### 4.4 删除警告

**接口路径**: `DELETE /api/admin/warnings/{warning_id}/`

**权限要求**: `is_superuser=True`

**响应数据**:

```json
{
  "code": 200,
  "msg": "警告删除成功"
}
```

---

## 5. 数据导出模块 (Export)

### 5.1 获取导出统计

**接口路径**: `GET /api/admin/export/stats/`

**权限要求**: `is_staff=True`

**响应数据**:

```json
{
  "code": 200,
  "msg": null,
  "data": {
    "stats": [
      {
        "type": "warnings",
        "name": "警告记录",
        "total_count": 150,
        "today_count": 8,
        "color": "#ff4757"
      },
      {
        "type": "detections",
        "name": "检测记录",
        "total_count": 1250,
        "today_count": 45,
        "color": "#3742fa"
      },
      {
        "type": "users",
        "name": "用户数据",
        "total_count": 50,
        "today_count": 2,
        "color": "#2ed573"
      }
    ]
  }
}
```

### 5.2 获取导出记录列表

**接口路径**: `GET /api/admin/export/records/`

**权限要求**: `is_staff=True`

**请求参数**:

```json
{
  "page": 1,
  "page_size": 10,
  "export_type": "warnings",   // 可选: warnings, detections, users
  "status": "completed",       // 可选: pending, processing, completed, failed
  "start_date": "2024-01-01",  // 可选: 开始日期
  "end_date": "2024-01-31"     // 可选: 结束日期
}
```

**响应数据**:

```json
{
  "code": 200,
  "msg": null,
  "data": {
    "records": [
      {
        "id": 1,
        "name": "2024年1月警告记录",
        "type": "warnings",
        "status": "completed",
        "progress": 100,
        "file_size": "2.5MB",
        "created_at": "2024-01-15T10:00:00.000Z",
        "completed_at": "2024-01-15T10:05:00.000Z"
      }
    ],
    "total_count": 25
  }
}
```

### 5.3 创建导出任务

**接口路径**: `POST /api/admin/export/tasks/`

**权限要求**: `is_staff=True`

**请求体**:

```json
{
  "export_type": "warnings",
  "task_name": "2024年1月警告记录",
  "filters": {
    "start_date": "2024-01-01",
    "end_date": "2024-01-31",
    "status": "resolved",
    "camera_id": "cam_001"
  }
}
```

**响应数据**:

```json
{
  "code": 201,
  "msg": "导出任务创建成功",
  "data": {
    "task_id": 123,
    "task_name": "2024年1月警告记录",
    "status": "pending"
  }
}
```

### 5.4 导出数据

**接口路径**: `POST /api/admin/export/data/`

**权限要求**: `is_staff=True`

**请求体**:

```json
{
  "export_type": "warnings",
  "format": "excel",  // excel, csv, pdf
  "filters": {
    "start_date": "2024-01-01",
    "end_date": "2024-01-31",
    "status": "resolved",
    "camera_id": "cam_001"
  }
}
```

**响应数据**:

```json
{
  "code": 200,
  "msg": "数据导出成功",
  "data": {
    "download_url": "/media/exports/warnings_2024_01.xlsx",
    "file_name": "warnings_2024_01.xlsx",
    "file_size": 2621440
  }
}
```

---

## 6. 通知管理模块 (Notifications)

### 6.1 获取通知列表

**接口路径**: `GET /api/admin/notifications/`

**权限要求**: `is_staff=True`

**请求参数**:

```json
{
  "page": 1,
  "page_size": 20,
  "is_read": false,     // 可选: 是否已读
  "is_public": true     // 可选: 是否公开通知
}
```

**响应数据**:

```json
{
  "code": 200,
  "msg": null,
  "data": {
    "notifications": [
      {
        "id": 1,
        "title": "系统维护通知",
        "content": "系统将于今晚进行维护",
        "is_public": true,
        "is_active": true,
        "created_at": "2024-01-15T10:00:00.000Z",
        "updated_at": "2024-01-15T10:00:00.000Z",
        "recipient_count": 50,
        "creator": {
          "id": 1,
          "username": "admin"
        }
      }
    ],
    "total": 25,
    "page": 1,
    "page_size": 20,
    "unread_count": 5
  }
}
```

### 6.2 创建通知

**接口路径**: `POST /api/admin/notifications/`

**权限要求**: `is_staff=True`

**请求体**:

```json
{
  "title": "系统维护通知",
  "content": "系统将于今晚进行维护",
  "is_public": true,
  "is_active": true,
  "notify_all": true,           // 可选: 是否通知所有用户
  "email_notification": false,  // 可选: 是否发送邮件
  "recipient_user_ids": [1, 2, 3]  // 可选: 指定接收用户ID列表
}
```

**响应数据**:

```json
{
  "code": 201,
  "msg": "通知创建成功",
  "data": {
    "notification_id": 2,
    "title": "系统维护通知"
  }
}
```

---

## 7. 系统配置模块 (Config)

### 7.1 获取配置列表

**接口路径**: `GET /api/admin/config/`

**权限要求**: `is_superuser=True`

**响应数据**:

```json
{
  "code": 200,
  "msg": null,
  "data": {
    "configs": [
      {
        "id": 1,
        "key": "email_settings",
        "name": "邮箱配置",
        "description": "系统邮箱发送配置",
        "is_active": true,
        "updated_at": "2024-01-15T10:00:00.000Z"
      }
    ]
  }
}
```

### 7.2 获取邮箱配置

**接口路径**: `GET /api/admin/config/email/`

**权限要求**: `is_superuser=True`

**响应数据**:

```json
{
  "code": 200,
  "msg": null,
  "data": {
    "smtp_host": "smtp.example.com",
    "smtp_port": 587,
    "smtp_user": "noreply@example.com",
    "smtp_password": "********",
    "use_tls": true,
    "from_email": "noreply@example.com"
  }
}
```

### 7.3 更新邮箱配置

**接口路径**: `PUT /api/admin/config/email/`

**权限要求**: `is_superuser=True`

**请求体**:

```json
{
  "smtp_host": "smtp.example.com",
  "smtp_port": 587,
  "smtp_user": "noreply@example.com",
  "smtp_password": "newpassword",
  "use_tls": true,
  "from_email": "noreply@example.com"
}
```

---

## 8. 错误码说明

### 8.1 HTTP状态码

- `200`: 请求成功
- `201`: 创建成功
- `400`: 请求参数错误
- `401`: 未认证
- `403`: 权限不足
- `404`: 资源不存在
- `500`: 服务器内部错误

### 8.2 业务错误码

```json
{
  "code": 400,
  "msg": "用户名已存在",
  "data": null
}
```

### 8.3 权限不足示例

```json
{
  "code": 403,
  "msg": "您没有权限执行此操作",
  "data": {
    "required_permission": "is_superuser",
    "current_permission": "is_staff"
  }
}
```

---

## 9. 认证说明

### 9.1 JWT Token格式

```
Authorization: Bearer <jwt_token>
```

### 9.2 Token刷新

**接口路径**: `POST /api/auth/refresh/`

**请求体**:

```json
{
  "refresh_token": "<refresh_token>"
}
```

### 9.3 权限验证流程

1. 验证JWT Token有效性
2. 检查用户是否激活 (`is_active=True`)
3. 根据接口要求验证权限级别
4. 返回相应的权限错误信息

---

## 10. 数据模型说明

### 10.1 用户模型 (User)

```python
class User(AbstractUser):
    email = models.EmailField(unique=True)
    is_active = models.BooleanField(default=True)
    is_staff = models.BooleanField(default=False)
    is_superuser = models.BooleanField(default=False)
    date_joined = models.DateTimeField(auto_now_add=True)
    last_login = models.DateTimeField(null=True, blank=True)
```

### 10.2 警告模型 (Warning)

```python
class Warning(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4)
    title = models.CharField(max_length=200)
    description = models.TextField()
    warning_level = models.CharField(max_length=20, choices=WARNING_LEVELS)
    status = models.CharField(max_length=20, choices=WARNING_STATUS)
    camera_id = models.CharField(max_length=50)
    created_at = models.DateTimeField(auto_now_add=True)
    resolved_by = models.ForeignKey(User, null=True, blank=True)
    resolved_at = models.DateTimeField(null=True, blank=True)
```

### 10.3 摄像头模型 (Camera)

```python
class Camera(models.Model):
    camera_id = models.CharField(max_length=50, unique=True)
    name = models.CharField(max_length=100)
    location = models.CharField(max_length=200)
    is_online = models.BooleanField(default=False)
    ip_address = models.GenericIPAddressField()
    port = models.IntegerField()
    rtsp_url = models.URLField()
    is_active = models.BooleanField(default=True)
    last_heartbeat = models.DateTimeField()
    created_at = models.DateTimeField(auto_now_add=True)
```

---

## 11. 部署说明

### 11.1 环境要求

- Python 3.8+
- Django 4.0+
- Django REST Framework 3.14+
- PostgreSQL 12+ (推荐)

### 11.2 配置示例

```python
# settings.py
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated',
    ],
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 20
}

SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(hours=1),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=7),
    'ROTATE_REFRESH_TOKENS': True,
}
```

### 11.3 URL配置

```python
# urls.py
urlpatterns = [
    path('api/admin/', include('apps.admin.urls')),
    path('api/auth/', include('apps.auth.urls')),
]
```

---

*文档版本: v1.0*
*最后更新: 2024-01-15*
